# Entity Draft

This document defines the proposed data entities for the Non-Emergency Medical Transportation System.

The data model supports:

- A familiar paper-like intake form
- Structured querying for scheduling and billing preparation
- Audit protection (what was entered for a specific trip remains historically accurate)
- Autosuggest to reduce duplicate names and phone entry errors
- Multi-tenant isolation (Healthcare Facility or Individual / Private Pay)

This is a design artifact only (no implementation required for IT599).

All TripRequests must be associated with exactly one tenant.

In this system, the tenant is represented by the Facility entity.

---

## Entity 1: Facility (Tenant)

### Definition

A billing and grouping account. Represents either:

- A healthcare facility  
- An individual/private-pay rider  

### Why it exists

Billing, grouping, and portal visibility are performed at the tenant level.  
Each TripRequest must belong to exactly one Facility (tenant).

### Attributes

- facility_id (PK) – unique identifier
- facility_name (required) – text
- facility_type (required) – enum (healthcare, individual)
- facility_main_phone (optional) – text (validated as 10 digits)
- facility_fax (optional) – text
- is_active (required) – boolean (default true)
- created_at (required) – datetime
- updated_at (required) – datetime

### Notes

- If facility_type = healthcare:
  - Represents a medical facility.
- If facility_type = individual:
  - Represents a private-pay rider account.
- facility_id must never be NULL on TripRequest.

---

## Entity 2: FacilityContact

### Definition

A reusable contact associated with a healthcare facility.

### Why it exists

Facilities often have multiple staff who schedule rides.  
Autosuggest reduces duplicate typing and errors.

### Attributes

- contact_id (PK)
- facility_id (FK → Facility.facility_id, required)
- contact_name (required)
- contact_role (optional)
- contact_phone (required)
- contact_ext (optional)
- is_primary (optional, default false)
- is_active (required, default true)
- created_at (required)
- updated_at (required)

### Notes

- FacilityContact applies only when facility_type = healthcare.
- Individual tenants do not require FacilityContact records.

---

## Entity 3: Patient

### Definition

A person receiving transportation services.

### Why it exists

Patients are repeat riders and must be searchable across time and tenants.

### Attributes

- patient_id (PK)
- first_name (required)
- middle_initial (optional)
- last_name (required)
- gender (required) – enum (male, female)
- active_patient_id (nullable FK → Patient.patient_id)
- is_active (required)
- created_at (required)
- updated_at (required)

### Notes

- active_patient_id supports reversible merges.
- TripRequest must always link to a canonical patient record.

---

## Entity 4: TripRequest

### Definition

A ride request created from intake (paper or digital).

### Why it exists

Central record connecting:

- Tenant (facility or individual)
- Patient
- Contact snapshot
- Scheduling details
- Billing grouping

### Attributes

- trip_request_id (PK)

### Links

- facility_id (FK → Facility.facility_id, required)
- patient_id (FK → Patient.patient_id, required)
- contact_id (FK → FacilityContact.contact_id, optional)
- submitted_by_user_id (nullable, external identity reference)

### Audit Fields

- created_via (required) – enum (guest, facility_portal, dispatcher_phone)

### Contact Snapshot (Audit Truth)

- contact_name_used (required)
- contact_phone_used (required)
- contact_ext_used (optional)
- contact_fax_used (optional)

### Trip Information

- order_date (required)
- service_date (required)
- pickup_time (required)
- appointment_time (required)
- back_time (optional)
- will_call (optional)
- trip_type (required) – enum (one_way, round_trip)
- wheelchair_type (required)
- pickup_address (required)
- dropoff_address (required)
- escort_present (optional)
- escort_identifier (optional)
- request_signature (required)

### Billing Authorization (Conditional)

- direct_billing_applies (optional)
- billing_authorization_signature (conditional)
- authorization_date (conditional)

### System Fields

- status (required) – enum (draft, scheduled, completed, cancelled)
- created_at (required)
- updated_at (required)

### Rules

- facility_id must never be NULL.
- If facility_type = individual:
  - contact fields represent the individual.
- TripRequest snapshot fields preserve original intake truth.

---

## Entity 5: TripLeg

### Definition

One completed transport leg.

A round trip results in two legs.

### Attributes

- trip_leg_id (PK)
- trip_request_id (FK → TripRequest.trip_request_id)
- driver_id (FK → Driver.driver_id, optional)

### Leg Identification

- leg_type (required) – enum (outbound, return)
- leg_sequence (optional)
- scheduled_pickup_time (optional)
- completed_flag (required, default false)

### Driver Completion Fields (conditional)

- driver_signature
- odometer_start
- start_time
- odometer_end
- end_time
- total_mileage

### Billing Workflow

- invoiced_flag (required)
- invoiced_month (optional)
- invoiced_date (optional)
- paid_flag (required)
- paid_date (optional)

### Notes

- One-way = 1 leg.
- Round trip = 2 legs.
- Facility roles cannot modify completed_flag or billing flags.

---

## Entity 6: Driver

### Definition

A driver who completes TripLegs.

### Attributes

- driver_id (PK)
- driver_name (required)
- phone_number (optional)
- is_active (required)
- created_at (required)
- updated_at (required)

---

## Relationships

- Facility (1) → (0..*) TripRequest
- Facility (1) → (0..*) FacilityContact
- Patient (1) → (0..*) TripRequest
- TripRequest (1) → (1..2) TripLeg
- Driver (1) → (0..*) TripLeg

---

## Intake Logic Rules

1. Requester selects Healthcare Facility or Individual.
2. If Healthcare Facility:
   - Select or create Facility where facility_type = healthcare.
3. If Individual:
   - Create or reuse Facility where facility_type = individual.
4. TripRequest.facility_id must always reference a valid Facility record.
